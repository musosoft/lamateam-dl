name: Sync & Update FastDL

on:
  workflow_dispatch: # Allows manual trigger
  schedule:
    - cron: '0 4 * * *' # Runs automatically every day at 4 AM UTC

permissions:
  contents: write

jobs:
  update-fastdl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y lftp bzip2

      - name: Download from Game Server (Quiet Mode)
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          REMOTE_PATH: ${{ secrets.FTP_REMOTE_PATH }}
        run: |
          echo "::group::FTP Synchronization"
          mkdir -p cstrike
          
          # Connects to FTP and syncs specifically fastdl relevant folders
          # --verbose is removed to reduce log spam
          # --delete ensures if you delete a map on the server, it is deleted here
          
          lftp -u "$FTP_USER,$FTP_PASS" $FTP_HOST <<EOF
          set ssl:verify-certificate no
          set ftp:passive-mode true
          cd "$REMOTE_PATH"
          mirror --continue --delete --only-newer --parallel=10 maps cstrike/maps
          mirror --continue --delete --only-newer --parallel=10 materials cstrike/materials
          mirror --continue --delete --only-newer --parallel=10 models cstrike/models
          mirror --continue --delete --only-newer --parallel=10 sound cstrike/sound
          mirror --continue --delete --only-newer --parallel=10 resource cstrike/resource
          quit
          EOF
          echo "FTP Download Complete."
          echo "::endgroup::"

      - name: Compress Files for FastDL (.bz2)
        run: |
          echo "::group::Compression Status"
          # Find specific game files that are NOT yet compressed and compress them
          # This loop checks for .bsp, .nav, .mdl, .wav, .vmt, .vtf
          
          find cstrike -type f \( -name "*.bsp" -o -name "*.nav" -o -name "*.mdl" -o -name "*.wav" -o -name "*.vmt" -o -name "*.vtf" \) -not -name "*.bz2" | while read FILE; do
            if [ ! -f "${FILE}.bz2" ]; then
              echo "Compressing: $FILE"
              bzip2 -z -k "$FILE"
            fi
          done
          
          # Optional: Remove the uncompressed files to save GitHub storage space
          # If you keep both, GitHub Pages might run out of space quickly.
          # Uncomment the line below to delete original files after compression:
          # find cstrike -type f \( -name "*.bsp" -o -name "*.nav" -o -name "*.mdl" -o -name "*.wav" \) -delete
          
          echo "Compression Complete."
          echo "::endgroup::"

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "FastDL Auto-Sync: Updated Maps & Assets"
          branch: main
          file_pattern: 'cstrike/**'
