name: Smart FastDL Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *' # Runs daily at 4 AM

permissions:
  contents: write

jobs:
  smart-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y lftp bzip2

      - name: Calculate Sync Threshold
        id: calc_date
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          REMOTE_PATH: ${{ secrets.FTP_REMOTE_PATH }}
        run: |
          echo "::group::Timestamp Calculation"
          
          echo "Fetching timestamp of maps/test_speakers.bsp..."
          
          # FIX: Removed invalid --date-format flag. 
          # We use 'cls -l' to get the standard long listing.
          RAW_OUTPUT=$(lftp -u "$FTP_USER,$FTP_PASS" -e "set ssl:verify-certificate no; cd '$REMOTE_PATH'; cls -l maps/test_speakers.bsp; quit" $FTP_HOST)
          
          echo "Raw FTP Output: $RAW_OUTPUT"

          # Parse the date using Regex. 
          # Matches standard Unix ls dates: "Mon DD HH:MM" (Recent) or "Mon DD YYYY" (Old)
          # Regex logic: 3 letters (Month) -> space -> 1-2 digits (Day) -> space -> Time OR Year
          EXTRACTED_DATE=$(echo "$RAW_OUTPUT" | grep -oE '[A-Za-z]{3}\s+[0-9]{1,2}\s+([0-9]{4}|[0-9]{1,2}:[0-9]{2})' | head -n 1)

          if [ -z "$EXTRACTED_DATE" ]; then
            echo "Error: Could not parse date from FTP output."
            echo "Defaulting to full sync."
            echo "SYNC_OPTS=" >> $GITHUB_ENV
          else
            echo "Server Ref Date: $EXTRACTED_DATE"
            
            # Calculate +30 minutes
            # 'date -d' is smart enough to parse "Dec 12 10:00" automatically
            CUTOFF_DATE=$(date -d "$EXTRACTED_DATE + 30 minutes" "+%Y-%m-%d %H:%M:%S")
            echo "Safe Zone Start: $CUTOFF_DATE"
            
            echo "SYNC_OPTS=--newer-than='$CUTOFF_DATE'" >> $GITHUB_ENV
          fi
          echo "::endgroup::"

      - name: Download Custom Content Only
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
          REMOTE_PATH: ${{ secrets.FTP_REMOTE_PATH }}
        run: |
          echo "::group::FTP Smart Sync"
          mkdir -p cstrike
          
          echo "Starting sync with options: $SYNC_OPTS"
          
          lftp -u "$FTP_USER,$FTP_PASS" $FTP_HOST <<EOF
          set ssl:verify-certificate no
          set ftp:passive-mode true
          cd "$REMOTE_PATH"
          
          # We mirror specific folders using the computed time filter
          # --delete is removed temporarily to prevent deleting local files if the filter excludes them this run
          # --verbose=0 keeps logs clean
          
          mirror --continue $SYNC_OPTS --parallel=10 --verbose=1 maps cstrike/maps
          mirror --continue $SYNC_OPTS --parallel=10 --verbose=1 materials cstrike/materials
          mirror --continue $SYNC_OPTS --parallel=10 --verbose=1 models cstrike/models
          mirror --continue $SYNC_OPTS --parallel=10 --verbose=1 sound cstrike/sound
          mirror --continue $SYNC_OPTS --parallel=10 --verbose=1 resource cstrike/resource
          quit
          EOF
          echo "::endgroup::"

      - name: Compress & Clean
        run: |
          echo "::group::Compression"
          # Compress new files to .bz2
          find cstrike -type f \( -name "*.bsp" -o -name "*.nav" -o -name "*.mdl" -o -name "*.wav" -o -name "*.vmt" -o -name "*.vtf" \) -not -name "*.bz2" | while read FILE; do
            if [ ! -f "${FILE}.bz2" ]; then
              echo "Compressing: $FILE"
              bzip2 -z -k "$FILE"
              # Delete the original uncompressed file to keep repo small
              rm "$FILE"
            fi
          done
          echo "::endgroup::"

      - name: Push Updates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "FastDL: Synced custom content"
          branch: main
          file_pattern: 'cstrike/**'
